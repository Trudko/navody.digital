<%= content_for :title, build_page_title('Adresa trvalého pobytu', 'Voľby do Európskeho parlamentu') %>
<%= content_for(:headerline, 'Voľby do Európskeho parlamentu') %>

<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds">
    <%= form_for @application_form do |f| %>
      <%= f.hidden_field :step %>
      <%= f.hidden_field :full_name %>
      <%= f.hidden_field :pin %>
      <%= f.hidden_field :nationality %>

      <h1 class="govuk-heading-l">Adresa trvalého pobytu</h1>

      <div class="govuk-form-group<% if @application_form.errors[:street].any? %> govuk-form-group--error<% end %>">
        <%= f.label :street, 'Ulica a číslo', class: 'govuk-label' %>
        <span class="govuk-hint">Napríklad: Kaštieľska 2</span>
        <% @application_form.errors[:street].each do |error| %>
          <span class="govuk-error-message"><%= error %></span>
        <% end %>
        <%= f.text_field :street, class: 'govuk-input govuk-input--width-20', required: true %>
      </div>

      <div class="govuk-form-group<% if @application_form.errors[:pobox].any? %> govuk-form-group--error<% end %>">
        <%= f.label :pobox, 'PSČ', class: 'govuk-label' %>
        <span class="govuk-hint">Napríklad: 841 01</span>
        <% @application_form.errors[:pobox].each do |error| %>
          <span class="govuk-error-message"><%= error %></span>
        <% end %>
        <%= f.text_field :pobox, class: 'govuk-input govuk-input--width-5' %>
      </div>

      <div class="govuk-form-group<% if @application_form.errors[:municipality].any? %> govuk-form-group--error<% end %>">
        <%= f.label :municipality, 'Obec', class: 'govuk-label', required: true %>
        <% @application_form.errors[:municipality].each do |error| %>
          <span class="govuk-error-message"><%= error %></span>
        <% end %>
        <div id="municipality-field" class="govuk-input--width-20">
          <%= f.text_field :municipality, class: 'govuk-input govuk-input--width-20 ep-vote-app' %>
        </div>
      </div>

      <%= f.hidden_field :municipality_email %>
      <%= submit_tag 'Pokračovať', class: 'govuk-button' %>

    <% end %>
  </div>
</div>

<style>
  .autocomplete__hint,
  .autocomplete__option {
    font-family: "Roboto", Arial, sans-serif;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
  }

  .autocomplete__hint,
  .autocomplete__input {
    padding: 5px 35px 5px 5px;
    font-family: "Roboto", Arial, sans-serif;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
    font-weight: 400;
    font-size: 16px;
    font-size: 1rem;
    line-height: 1.25;
    height: 40px;
  }

  @media (min-width: 40.0625em) {
    .autocomplete__hint,
    .autocomplete__input {
      font-size: 18px;
      font-size: 1.125rem;
      line-height: 1.33333;
    }
  }
</style>

<%= javascript_include_tag 'apps/ep_vote_app/libs.js', 'data-turbolinks-track': 'reload' %>
<script>
  var municipalities = [];
  var municipalityEmails = {};

  for (var i = 0; i < SLOVAK_MUNICIPALITIES.length; i++)
  {
    var municipality = SLOVAK_MUNICIPALITIES[i];

    var searchText = replaceDiacritics(municipality[0]).toLowerCase();
    var label = municipality[0] + (municipality[2] !== '' ? (' (' + municipality[2] + ')') : '');

    SLOVAK_MUNICIPALITIES[i][3] = searchText.replace(/[ -]+/g, ' ');
    SLOVAK_MUNICIPALITIES[i][4] = label;

    municipalities.push(label);
    municipalityEmails[label] = municipality[1];
  }

  accessibleAutocomplete({
    element: document.getElementById('municipality-field'),
    id: 'apps_ep_vote_app_application_form_municipality',
    displayMenu: 'overlay',
    showAllValues: true,
    autoselect: true,
    source: function (query, populateResults) {
      var results = [];

      if (query === '') {
        results = municipalities;
      } else {
        var term = replaceDiacritics(query).toLowerCase();

        for (var i = 0; i < municipalities.length; i++) {
          var municipality = SLOVAK_MUNICIPALITIES[i];

          var index = municipality[3].indexOf(term);
            if (index > -1) {
              if (index === 0 || municipality[3][index - 1] === ' ') {
                results.push(municipality[4]);
              }
            }
          if (results.length > 20) break;
        }
      }

      results = results.sort(function (a, b) {
        return ((a < b) ? -1 : ((a > b) ? 1 : 0));
      });

      populateResults(results);
    },
    tNoResults: function () {
      return 'Obec sa nenašla.';
    },
    onConfirm: function (value) {
      document.querySelector('#apps_ep_vote_app_application_form_municipality_email').value = municipalityEmails[value] ? municipalityEmails[value] : '';
    }});
</script>
